#!/bin/bash

set -e  # Exit on error

# Specify dotfiles directory
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

DISTRO=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')

# --------------- Detect OS & Package Manager ---------------
detect_package_manager() {
    if command -v apt &> /dev/null; then
        PKG_MANAGER="apt"
        INSTALL_CMD="sudo apt install -y"
        UPDATE_CMD="sudo apt update"
    elif command -v dnf &> /dev/null; then
        PKG_MANAGER="dnf"
        INSTALL_CMD="sudo dnf install -y"
        UPDATE_CMD="sudo dnf check-update || true"
    elif command -v pacman &> /dev/null; then
        PKG_MANAGER="pacman"
        INSTALL_CMD="sudo pacman -S --noconfirm"
        UPDATE_CMD="sudo pacman -Sy"
    elif command -v zypper &> /dev/null; then
        PKG_MANAGER="zypper"
        INSTALL_CMD="sudo zypper install -y"
        UPDATE_CMD="sudo zypper refresh"
    elif command -v brew &> /dev/null; then
        PKG_MANAGER="brew"
        INSTALL_CMD="brew install"
        UPDATE_CMD="brew update"
    else
        echo "Error: No supported package manager found"
        exit 1
    fi
    
    echo "Detected package manager: $PKG_MANAGER"
}

# --------------- Install package function ---------------
install_package() {
    local package=$1
    
    if ! command -v "$package" &> /dev/null; then
        echo "Installing $package..."
        $INSTALL_CMD "$package"
    else
        echo "$package already installed"
    fi
}

install_repo() {
    local name=$1
    local url=$2
    local destination=$3
    
    if [ ! -d "$destination" ]; then
        echo "Installing $name to $destination..."
        git clone "$url" "$destination"
        echo "$name installed"
    else
        echo "$name already installed"
    fi
}

# --------------- Main Installation ---------------
detect_package_manager

echo "Installing dotfiles from $DOTFILES_DIR"
cd "$DOTFILES_DIR"

# Update package lists
echo "Updating package lists..."
$UPDATE_CMD

# Install dependencies
echo "Installing dependencies..."
install_package stow
install_package git
install_package curl
install_package zsh
install_package tmux
install_package waybar
install_package wallust 
install_package rofi
install_package zathura
install_package hyprland
install_package sway

# --------------- Stow packages ---------------
echo "Stowing dotfiles..."
stow nvim
stow tmux
stow git
stow zsh
stow waybar 
stow wallust
stow rofi
stow zathura
stow hypr

# --------------- nvim ---------------
echo "Setting up nvim..."

# --------------- tmux ---------------
echo "Setting up tmux..."

# Install TPM
install_repo "TPM" "https://github.com/tmux-plugins/tpm" "$HOME/.config/tmux/plugins/tpm"

# --------------- zsh ---------------
echo "Setting up zsh..."

# Set zsh as default shell
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "Setting zsh as default shell..."
    chsh -s "$(which zsh)"
fi

# --------------- git ---------------
echo "Setting up git..."

# --------------- waybar ---------------
echo "Setting up waybar..."

# --------------- wallust ---------------
echo "Setting up wallust..."

# --------------- rofi ---------------
echo "Setting up rofi..."

install_package brightnessctl
install_package acpi
install_package power-profiles-daemon
install_package networkmanager
install_package iproute2
install_package gawk
install_package mpc
install_package alsa-utils
install_package libnotify
install_package hyprland
install_package hyprlock
install_package hyprsunset
install_package sway
install_package swaybg
install_package gammastep

case $PKG_MANAGER in
    pacman)
        install_package bluez-utils
        ;;
    apt|dnf|zypper)
        install_package bluez
        ;;
    brew)
        install_package bluez
        ;;
esac


# --------------- zathura ---------------
echo "Setting up zathura..."

# --------------- hypr ---------------
echo "Setting up hypr..."

install_package alacritty 
install_package dolphin
install_package eww
install_package keyd
install_package grimblast
install_package wireplumber
install_package playerctl 

# --------------- keyd ---------------
echo "Setting up keyd..."

sudo mkdir -p /etc/keyd
sudo cp ~/.dotfiles/keyd/etc/keyd/default.conf /etc/keyd/
sudo systemctl enable --now keyd

echo ""
echo "Dotfiles installed!"
echo ""
echo "Next steps:"
echo "1. Install JetBrains Nerd Font Mono"
echo "2. Restart your terminal or run: exec zsh"
echo "3. In tmux, press <prefix> + I to install plugins"
echo "4. Press Windows key + m and choose a theme to generate colors for the programs"
